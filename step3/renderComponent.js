/*!
 * 
 *  基于Zepto || jQuery的组件
 *  $.fn.renderComponent
 *  @author: Micheal Wang
 *  @build time: 2017.12.05
 *  @github: https://github.com/MichealWayne/component/blob/master/step3/renderComponent.js
 *  @bolg: https://michealwayne.github.io/2017/12/04/%EF%BC%88Zepto-jQuery%EF%BC%893%E8%A1%8C%E4%BB%A3%E7%A0%81%E5%BC%80%E5%90%AF%E5%89%8D%E7%AB%AF%E7%BB%84%E4%BB%B6%E5%A4%8D%E7%94%A8%E4%B9%8B%E6%97%85%EF%BC%88%E4%BA%8C%EF%BC%89/
 *  
 * @param {Object} options: 调用参数
 *        {String} url: 组件路径 || DOM的r-url属性
 *        {Object} value: 变量 || DOM的r-value属性
 *        {Function} callback: 回调
 * @component usage：组件说明
 *     {{变量名}}：变量替换；
 *     {{r="列表变量名"}}...{{r-end}}：列表渲染；
 *     <style>...</style>: 影响主页面的css（可不加变量，only one）；
 *     <style private>...</style>：不影响主页面私有css（可加变量，only one）；
 *     <script>...</script>：组件js（只渲染一次）；
 * @cache explain: 缓存说明 $.Components
 *     key：组件标识（路径）；
 *         {Object} attr：组件属性
 *             {String} name: 组件名；
 *             {String} value: 组件标识（随机字符串）；
 *         {Object} content：组件内容
 *             {Array} cssArr：私有css数组；
 *             {String} html: html缓存；
 *         {Array} tasks: 任务队列；
 *         {Boolean || Undefined} ajaxError: 加载错误
 * 
 */
!function(e){function t(n){if(r[n])return r[n].exports;var o=r[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,t),o.l=!0,o.exports}var r={};t.m=e,t.c=r,t.d=function(e,r,n){t.o(e,r)||Object.defineProperty(e,r,{configurable:!1,enumerable:!0,get:n})},t.n=function(e){var r=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(r,"a",r),r},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="D:\\build\\dist\\step3",t(t.s=1)}([function(module,exports,__webpack_require__){"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Regs={variable:/{{(\S*)}}/g,list:/{{r-for="(\w*)"}}/g,css:/<style>(([\s\S])*?)<\/style>/,cssPrivate:/<style\s+private>(([\s\S])*?)<\/style>/,js:/<script>(([\s\S])*?)<\/script>/};String.prototype.trim=function(){return this.replace(/(^\s*)|(\s*$)/g,"")};var removeSpaceAndLinebreak=function(e){return e.replace(/(^\s*)|(\s*$)/g,"").replace(/\s\s/g,"").replace(/<\/?.+?>/g,"").replace(/[\r\n\t]/g,"")},getRandomAttr=function(){return Math.random().toString(36).substr(2,8)},toObject=function toObject(item){if("object"===(void 0===item?"undefined":_typeof(item)))return item;if("string"==typeof item){var result=void 0;try{result=JSON.parse(item)}catch(e){eval("result="+item)}return result}};module.exports={Regs:Regs,removeSpaceAndLinebreak:removeSpaceAndLinebreak,getRandomAttr:getRandomAttr,toObject:toObject}},function(e,t,r){"use strict";var n=r(0),o=r(2),s=function(e){return e&&e.__esModule?e:{default:e}}(o);if(!$)throw new Error("Error! This script need Zepto or jQuery.");$.Components&&console.warn('Error! "$.Components" will be redefined.'),$.Components={};var a=new s.default;$.fn.renderComponent=function(){var e,t,r,o=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},s=$(this);if(e=o.url||s.attr("r-url"),t=o.value||s.attr("r-value"),r=o.callback,!e)return!1;t&&(t=(0,n.toObject)(t));var i=$.Components[e];if(i){if(!i.ajaxError){if(!i.content)return $.Components[e].tasks.push({dom:s,options:o}),-1;var u="",c=i.attr.name;if(i.content.cssArr&&i.content.cssArr.length){var l=void 0,f=void 0;l=a.renderPrivateCss(i.content.cssArr,c),f=l[0],u=l[1],f&&$("head").append("<style>"+a.renderVar(f,t)+"</style>")}return s.attr(c,u).html(a.renderHtml(i.content.html,t)),r&&r(s),1}}else $.Components[e]={tasks:[]};$.ajax({url:e,success:function(o){var i=e.split("/"),u="r-"+i[i.length-1].split(".")[0];t["r-attr"]=u;var c=a.fetchCss(o),l=c[0],f=c[0],p=c[1]+c[2],d=a.renderPrivateCss(c[3],u),v=d[1];p+=d[0],l=a.renderHtml(l,t);var m="";f=f.replace(n.Regs.js,""),l=l.replace(n.Regs.js,function(e,t){return t&&(m=t),""}),p&&$("head").append("<style>"+a.renderVar(p,t)+"</style>"),s.attr(u,v).html(l),m&&$("body").append("<script>"+m+"<\/script>"),$.Components[e].content={html:f,cssArr:c[3]},$.Components[e].attr={name:u,value:v},r&&r(s);var y=$.Components[e].tasks;if(y&&y.length){for(var b in y)y[b].dom.renderComponent(y[b].options);$.Components[e].tasks=[]}},error:function(t){if($.Components[e].ajaxError)return console.log('Warning! The component "'+e+'" request failed.（'+t.status+"）"),!1;(~t.textStatus.indexOf("timeout")||4!==t.readyState)&&($.Components[e].ajaxError=!0,s.renderComponent(o))}})}},function(e,t,r){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},s=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),a=r(0),i=r(3),u=function(e){return e&&e.__esModule?e:{default:e}}(i),c=new u.default,l=function(){function e(){n(this,e)}return s(e,[{key:"renderVar",value:function(e,t){return!!t&&e.replace(a.Regs.variable,function(e,r){var n=r.trim();return t[n]||""})}},{key:"renderList",value:function(e,t){if(!a.Regs.list.test(e))return e;var r=[];e.replace(a.Regs.list,function(e,t){r.push(t)});for(var n in r)e=function(e,r){var n=new RegExp('{{r-for="'+e+'"}}([\\s\\S*]+?){{r-end}}');return r.replace(n,function(r,n){for(var s="",i=0;i<t[e].length;i++)!function(r){s+=n.replace(a.Regs.variable,function(n,s){return s=s.trim(),("object"==o(t[e][r])?t[e][r][s]:t[e][r])||""})}(i);return s})}(r[n],e);return e}},{key:"fetchCss",value:function(e){var t="",r="";e=e.replace(a.Regs.css,function(e,r){return r&&(t=r),""});var n=!1,o=[];return a.Regs.variable.test(e)&&(n=!0),e=e.replace(a.Regs.cssPrivate,function(e,t){return t&&c.doCssScan({data:t,handleStyle:function(e){var t=("[{{r-attr}}] "+e.selector).replace(",",",[{{r-attr}}] ");n&&(a.Regs.variable.test(e.selector)||a.Regs.variable.test(e.content))?(o.push({selector:t,content:e.content}),t=""):r+=t+"{"+e.content+"}"}}),""}),[e,t,r,o]}},{key:"renderPrivateCss",value:function(e,t){if(!e.length||!t)return"";var r="",n=(0,a.getRandomAttr)();for(var o in e)r+=e[o].selector.replace(/{{r-attr}}/g,t+'="'+n+'"')+"{"+e[o].content+"\n}";return[r,n]}},{key:"renderHtml",value:function(e,t){var r=this.renderList(e,t);return this.renderVar(r,t)}}]),e}();t.default=l},function(e,t,r){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),s=r(0),a=function(){function e(){n(this,e),this.index=0,this.status="off"}return o(e,[{key:"end",value:function(e){this.index=0,this.status="off",e&&e()}},{key:"doCssScan",value:function(e){var t=this,r={selector:"",content:""},n=(0,s.removeSpaceAndLinebreak)(e.data),o=n.length;for(t.status="selector",t.index=0;t.index<o;t.index++){var a=n[t.index],i=t.status;"{"===a&&!~n.slice(t.index-1,t.index+2).indexOf("{{")||"}"===a&&(t.index===o-1||!~n.slice(t.index-1,t.index+2).indexOf("}}"))?t.status="selector"===i?"content":"selector":(r[t.status]||" "!=a)&&(r[t.status]+=n[t.index]),t.status!==i&&"content"===i&&(e.handleStyle&&e.handleStyle(r),r.selector="",r.content="")}t.end(e.callback)}}]),e}();t.default=a}]);